
## collect columns to make a new data

```
import pandas as pd
import re

# 1. Load merged file

merged_file = "merged_full_with_duplicates.tsv"
merged = pd.read_csv(merged_file, sep="\t", dtype=str, low_memory=False)

print(f"Loaded merged file with {merged.shape[0]} rows and {merged.shape[1]} columns.")


# 2. Columns to ALWAYS keep
# (all columns from SRA metadata + spire_sample_name)
sra_full = pd.read_csv("SRA_metadata_with_biosample_corrected.txt", sep=",", dtype=str)

sra_columns = set(sra_full.columns)

always_keep = set(sra_columns)
always_keep.add("spire_sample_name")

# 3. Keyword categories we WANT to keep from human metadata
# (flexible, case-insensitive)

keywords = [
    "bmi",
    "body mass",
    "antibiotic",
    "antimicrobial",
    "drug",
    "sex",
    "gender",
    "age",
    "disease",
    "diagnosis",
    "condition",
    "infection",
    "immune",
    "inflammation",
    "therapy",
    "treatment"
]


# 4. Keywords to EXCLUDE
# (Columns containing these will be dropped)

exclude_keywords = [
    "sexual",       
    "private",
    "identifier",
    "confidential",
    "contact",
    "gestational",
    "beverages",
    "stage",
    "vitamin",
    "alcohol",
    "average",
    "home",
    "sports",
    "strength",
    "siblings"
]


def is_unwanted(col):
    col_low = col.lower()
    return any(bad in col_low for bad in exclude_keywords)

# 5. Determine which columns match keyword categories

def matches_category(col):
    col_low = col.lower()
    return any(re.search(rf"{kw}", col_low) for kw in keywords)

keyword_columns = {c for c in merged.columns if matches_category(c)}

# 6. Compute the final set of columns to keep

columns_to_keep = (always_keep | keyword_columns)

columns_to_keep = {c for c in columns_to_keep if not is_unwanted(c)}

columns_to_keep = sorted([c for c in columns_to_keep if c in merged.columns])

print(f"\nTotal columns kept: {len(columns_to_keep)}")

# 7. Create cleaned dataframe

merged_cleaned = merged[columns_to_keep]

# 8. Save output

output_file = "merged_filtered_cleaned.tsv"
merged_cleaned.to_csv(output_file, sep="\t", index=False)

print(f"\n✅ Cleaned dataset saved to: {output_file}")
print(f"✅ Final shape: {merged_cleaned.shape[0]} rows x {merged_cleaned.shape[1]} columns")

```


```
df = pd.read_csv("merged_filtered_cleaned.tsv", sep="\t")
```
Remove columns with no values

```
# Drop columns that are entirely empty (all NaN)
df = df.dropna(axis=1, how='all')

```

BMI

```
df = pd.read_csv("merged_filtered_cleaned.tsv", sep="\t")

df["BMI_range"].unique()
df["bmi"].unique()
df["bmi_range"].unique()

df.loc[df["BMI_range"].isna() & (df["bmi"] < 30), "BMI_range"] = "<30"
df.loc[df["BMI_range"].isna() & (df["bmi"] >= 30), "BMI_range"] = ">30"

```
Antibiotics:

```
df["days_since_antibiotics"].unique()

# create a new column based if antibiotics have been taken or not
df["antibiotic_taken"] = df["days_since_antibiotics"].notna().map({True: "Yes", False: "No"})
df = df.drop(columns=["days_since_antibiotics"])

df["antibiotic"].unique()
#remove empty column
df = df.drop(columns=["antibiotic"])

df["Drug_antibiotic_last3y"].unique()
df["antibiotic_taken"] = df["Drug_antibiotic_last3y"].apply(
    lambda x: "No" if pd.isna(x) or x == "No" else "Yes"
)
df = df.drop(columns=["Drug_antibiotic_last3y"])

df["antibiotic_dosage"].unique()
#remove empty column
df = df.drop(columns=["antibiotic_dosage"])

df["raw_metadata_AgeAtEnd_Antibiotic_1"].unique()
#remove empty column
df = df.drop(columns=["antibiotic_dosage"])




df[""].unique()
```


Remove other unnecessary columns

```
columns_to_drop = [
    "collection_date_sam",
    "cultivation_condition",
    "raw_metadata_Age.of.Mother",
    "age_days",
    "raw_metadata_AgeDischargedDays",
    "raw_metadata_Age_at_collection"
]

df = df.drop(columns=columns_to_drop)
```


df.to_csv("kesken.tsv", sep="\t", index=False)



